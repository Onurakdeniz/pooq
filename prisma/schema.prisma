generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String      @id @unique
  fid        Int?        @unique
  userName   String?     @unique
  bookmarks  Bookmark[]
  parentTags ParentTag[] // User follows ParentTags, not Tags
  categories Category[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  llmFeeds   LLMFeed[]
}

model Author {
  fid       Int      @id @unique
  userName  String
  posts     Post[]
  stories   Story[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum StoryType {
  DEFINITION
  FACTOID
  DEEP_DIVE
  QUERY
  OPINION
  EVENT
  REVIEW
  CHALLENGE
  OBSERVATION
  CONFLICT
  GUIDANCE
}

model Story {
  id          String      @id @unique @default(uuid())
  hash        String      @unique
  authorId    Int
  text        String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  isProcessed Boolean     @default(false)
  bookmarks   Bookmark[]
  extraction  Extraction?
  posts       Post[]
  author      Author      @relation(fields: [authorId], references: [fid], onDelete: Cascade)
}

model Post {
  id              String      @id @unique @default(uuid())
  hash            String      @unique
  authorId        Int
  text            String
  storyId         String
  isSpamSuspected Boolean?
  isStoryRelated  Boolean?
  isProcessed     Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  extraction      Extraction?
  bookmarks       Bookmark[]
  author          Author      @relation(fields: [authorId], references: [fid], onDelete: Cascade)
  story           Story       @relation(fields: [storyId], references: [id], onDelete: Cascade)
}

model Extraction {
  id          Int                    @id @default(autoincrement())
  storyId     String?                @unique
  postId      String?                @unique
  title       String
  description String?
  view        String?
  type        StoryType?
  post        Post?                  @relation(fields: [postId], references: [id], onDelete: Cascade)
  story       Story?                 @relation(fields: [storyId], references: [id], onDelete: Cascade)
  tags        TagOnExtraction[]
  entities    EntityOnExtraction[]
  categories  CategoryOnExtraction[]
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
}

model Bookmark {
  id        String   @id @default(uuid())
  userId    String
  storyId   String?
  postId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  story     Story?   @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId])
  @@unique([userId, postId])
}

model Category {
  id          String                 @id @default(uuid())
  name        String                 @unique
  description String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt
  extractions CategoryOnExtraction[]
  users       User[]
}

model CategoryOnExtraction {
  categoryId   String
  extractionId Int
  category     Category   @relation(fields: [categoryId], references: [id])
  extraction   Extraction @relation(fields: [extractionId], references: [id], onDelete: Cascade)

  @@id([categoryId, extractionId])
}

model LLMFeed {
  id        String   @id @default(uuid())
  text      String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tags      Tag[]
}

model Tag {
  id          String            @id @default(uuid())
  name        String            @unique
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  extractions TagOnExtraction[]
  llmFeeds    LLMFeed[]
}

model TagOnExtraction {
  tagId        String
  extractionId Int
  tag          Tag        @relation(fields: [tagId], references: [id])
  extraction   Extraction @relation(fields: [extractionId], references: [id], onDelete: Cascade)

  @@id([tagId, extractionId])
}

model ParentTag {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  followers   User[] // ParentTags are followed by Users
}

model Entity {
  id          String               @id @default(uuid())
  name        String               @unique
  description String?
  extractions EntityOnExtraction[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

model EntityOnExtraction {
  entityId     String
  extractionId Int
  entity       Entity     @relation(fields: [entityId], references: [id])
  extraction   Extraction @relation(fields: [extractionId], references: [id], onDelete: Cascade)

  @@id([entityId, extractionId])
}

 